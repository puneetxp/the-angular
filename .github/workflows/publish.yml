name: Publish Package

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
    paths:
      - '.github/workflows/publish.yml'

permissions:
  id-token: write         # required for OIDC
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Get GitHub OIDC id token
        id: get_id_token
        run: |
          # request the OIDC id token from GitHub
          # npm expects the audience claim to be "npm"
          ID_TOKEN_RESPONSE=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=npm")
          ID_TOKEN=$(echo "$ID_TOKEN_RESPONSE" | jq -r '.value')
          if [ -z "$ID_TOKEN" ] || [ "$ID_TOKEN" = "null" ]; then
            echo "Failed to extract id_token from OIDC response" >&2
            exit 1
          fi
          echo "id_token=${ID_TOKEN}" >> $GITHUB_OUTPUT

      - name: Exchange id token for npm shortâ€‘lived token
        id: npm_exchange
        run: |
          # Replace <NPM_EXCHANGE_URL> and payload per npm docs.
          # Example template (replace with exact endpoint & JSON structure from npm docs):
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            --data "{\"id_token\":\"${{ steps.get_id_token.outputs.id_token }}\"}" \
            "https://www.npmjs.com/api/tokens/exchange")
          HTTP_STATUS=${RESPONSE##*$'\n'}
          BODY=${RESPONSE%$'\n'*}
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "npm token exchange failed (status $HTTP_STATUS): $BODY" >&2
            exit 1
          fi
          # Parse the returned npm token name/value per npm docs; store token to $GITHUB_OUTPUT
          TOKEN=$(echo "$BODY" | jq -er '.token')
          echo "npm_token=${TOKEN}" >> $GITHUB_OUTPUT

      - name: Publish to npm
        working-directory: dist/the-angular
        env:
          NODE_AUTH_TOKEN: ${{ steps.npm_exchange.outputs.npm_token }}
        run: npm publish --provenance --access public